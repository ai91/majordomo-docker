# Настройка конфигурации (`config.php`)
В примерах быстрого старта, в файле `docker-compose.yml` можно увидеть следующий блок:
```yml
...
    environment:
      MAJORDOMO_DB_HOST: majordomo_db
      MAJORDOMO_DB_NAME: db_terminal
      MAJORDOMO_DB_USER: root
      MAJORDOMO_DB_PASSWORD: rootpassword
...
```
Данный блок создает соответсвующие конфигурационные константы в [config.php](https://github.com/sergejey/majordomo/blob/master/config.php.sample):
```php
...
Define('DB_HOST', 'majordomo_db');
Define('DB_NAME', 'db_terminal');
Define('DB_USER', 'root');
Define('DB_PASSWORD', 'rootpassword');
...
```

Для создания любой конфигурационной константы, достаточно добавить в переменные окружения соответсвующую переменную, с префиксом `MAJORDOMO_`. 
Т.е. чтобы в конфигурацию добавилась константа `XXX`, надо задать переменную окружения `MAJORDOMO_XXX`.

# Секреты и константы из внешних файлов
В некоторых ситуациях значение конфигурационной константы необходимо передать через внешний файл. Типичный пример - секрет.
Для этого необходимо добавить в переменные окружения переменную с префиксом `MAJORDOMO_` и суффиком `_FILE`. Например задание `MAJORDOMO_XXX_FILE: /var/xxx.txt` приведет к созданию конфигурационной константы `XXX` со значением из файла `/var/xxx.txt`.
> [!NOTE]
> Файл на который ссылается переменная окружения должен быть доступен *внутри контейнера*.
#### Пример с секретом:
```yml
...
services:
  majordomo:
...
    environment:
      MAJORDOMO_DB_PASSWORD_FILE: /run/secrets/majordomo_db_root_pw
    secrets:
      - majordomo_db_root_pw
...
secrets:
  majordomo_db_root_pw:
    file: /root/secrets/majordomo_db_root_pw
...
```
Здесь `/root/secrets/majordomo_db_root_pw` - расположение файла на хост-машине, `/run/secrets/majordomo_db_root_pw` - расположение файла внутри контейнера.
#### Пример с переменной во внешнем файле:
```yml
...
services:
  majordomo:
...
    volumes:
      - ./git.url:/var/www/html/git.url
    environment:
      MAJORDOMO_GIT_URL_FILE: /var/www/html/git.url
...
```
Здесь `/var/docker/majordomo/git.url` - расположение файла на хост-машине, `/var/www/html/git.url` - расположение файла внутри контейнера. В результаре создастся конфигурационная константа 
```php
Define ('GIT_URL', 'содержимое файла');
```

# Восстановление файлов из базового образа и защита от восстановления
Образ `majordomo-docker` содержит в себе копию MajorDoMo. Т.е. при первом запуске он ничего не скачивает из интернета, а разворачивает слепок проекта в том виде, каким он был при создании образа разработчиками.
Технически это реализовано следующим образом.
Структура контейнера:
```
/
├─ var/
│  └─ www/
│     ├─ majordomo/
│     │  └─ ...                    <-- r/o слепок проекта, на момент создания докер-контейнера
│     └─ html/
│        └─ ...                    <-- r/w рабочая копия проекта, она же директория вебсервера.
└─ usr/
   └─ local/
      └─ bin/
         └─ majordomo.sh           <-- стартовый скрипт

```
Стартовый скрипт контейнера (`/usr/local/bin/majordomo.sh`) занимается копированием содержимого из `/var/www/majordomo` в `/var/www/html`.
Как показывалось в [быстром старте](firststart.md), директория `/var/www/html` внутри контейнера - маунтится из хост-машины (в примерах это `/var/docker/majordomo/majordomo/`).

Таким образом, после первого запуска контейнера, в директории `/var/docker/majordomo/majordomo/` хост-машины окажется копия MajorDoMo в том виде, в каком она была на момент создания `majordomo-docker` образа.
Если по какой-либо причине содержимое `/var/docker/majordomo/majordomo/` окажется изменено, то при следующем старте контейнера все изменённые/удалённые файлы будут восстановлены.

Важное замечание: восстанавливаются только те файлы, которые содержатся в базовом образе. Файлы которые не существуют в базовом образе (были созданы в пользовательских поддиректориях, или установленные плагины) - не удаляются.

Данное поведение позволяет восстанавливать поврежденную инсталяцию и "замораживать" рабочую копию. В то же время, это препятсвует внесению желаемых изменений в базовые файлы, а также не позволяет обновлять систему средствами самого MajorDoMo.

В случае если необходимо изменить какой-либо системный файл таким образом, чтобы он не откатывался при перезапуске, введена поддержка переменной окружения `MAJORDOMO_DONT_RESTORE_FILES` (и соответсвенно `MAJORDOMO_DONT_RESTORE_FILES_FILE`, если надо указать большой список исключений).
Данная переменная содержит список файлов относительно рабочей директории, которые стартовый скрипт должен пропустить.

> [!NOTE]
> Переменная `MAJORDOMO_DONT_RESTORE_FILES` (и файл `MAJORDOMO_DONT_RESTORE_FILES_FILE`) могут содержать файлы, директории, маски в формате утилиты `rsync` (см. формат [`--exclude-from`](https://linuxize.com/post/how-to-exclude-files-and-directories-with-rsync/) ) .

Пример `docker-compose.yml`:
```yml
...
services:
  majordomo:
...
    environment:
      MAJORDOMO_DONT_RESTORE_FILES: scripts/cycle_connect.php,modules/connect
...
```
Данная конфигурация указывает что файл `scripts/cycle_connect.php` и вся директория `modules/connect` не должны восстанавливаться. Таким образом можно удалить модуль `Connect` средствами MajorDoMo, и он не будет самовосстанавливаться при перезапуске контейнера.

Аналогичным образом решается проблема обновлений средствами самого MajorDoMo: чтобы позволить обновления через панель управления - достаточно в MAJORDOMO_DONT_RESTORE_FILES указать все файлы:
```yml
...
services:
  majordomo:
...
    environment:
      MAJORDOMO_DONT_RESTORE_FILES: "*"
...
```
> [!CAUTION]
> Обновления на "замороженой" конфигурации могут ввести в заблуждение: при обновлении через панель управления, обновляются файлы в рабочей директории и в базе данных создаются записи об обновлении. При перезапуске контейнера, рабочая директория восстанавливается к исходному состоянию, однако записи в БД остаются.
> Таким образом после перезапуска контейнера в интерфейсе будет отображаться неверное состояние системы - "последние обновления установлены", хотя фактически сами файлы будут устаревшими.
> Т.е. если не указана переменная окружения `MAJORDOMO_DONT_RESTORE_FILES: "*"`, то пользоваться обновлением системы через панель управления не рекомендуется.


# Инициализация базы данных

# Обновления